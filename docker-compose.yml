# FiGS full development environment (with coverage_view_selection)
# For the environment without coverage_view_selection, use docker-compose.base.yml instead.
# For SINGER development, use the docker-compose.yml in the SINGER repo instead.

services:
  figs:
    image: figs:latest
    build:
      context: .
      dockerfile: Dockerfile.FiGS
      args:
        CUDA_ARCHITECTURES: ${CUDA_ARCHITECTURES:-}
    volumes:
      # Mount FiGS-Standalone for editable install (editable from host and container)
      - .:/workspace/FiGS-Standalone
      # Mount coverage_view_selection for editable install
      - ../coverage_view_selection:/workspace/coverage_view_selection
      # Mount data directory at same path as host so symlinks work
      - ${DATA_PATH:-/media/admin/data/StanfordMSL/nerf_data}:${DATA_PATH:-/media/admin/data/StanfordMSL/nerf_data}
    working_dir: /workspace/FiGS-Standalone
    environment:
      - DISPLAY=${DISPLAY:-}
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-0}
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    network_mode: host
    shm_size: '12gb'
    stdin_open: true
    tty: true
    command: >
      bash -c "
        HOST_UID=$$(stat -c '%u' /workspace/FiGS-Standalone)
        HOST_GID=$$(stat -c '%g' /workspace/FiGS-Standalone)
        if ! getent passwd $$HOST_UID >/dev/null 2>&1; then
          groupadd -g $$HOST_GID figs 2>/dev/null || true
          useradd -u $$HOST_UID -g $$HOST_GID -m -s /bin/bash figs 2>/dev/null || true
        fi
        USERNAME=$$(getent passwd $$HOST_UID | cut -d: -f1)
        # Fix any root-owned egg-info dirs from previous runs
        find /workspace -maxdepth 3 -name '*.egg-info' -not -user $$HOST_UID -exec chown -R $$HOST_UID:$$HOST_GID {} + 2>/dev/null || true
        # Install editable packages as host user so .egg-info is host-owned
        runuser -u $$USERNAME -- python -m pip install -e /workspace/FiGS-Standalone --no-deps -q || { echo 'FATAL: failed to install figs'; exit 1; }
        runuser -u $$USERNAME -- python -m pip install -e /workspace/FiGS-Standalone/gemsplat --no-deps -q || { echo 'FATAL: failed to install gemsplat'; exit 1; }
        python -m pip install -e /workspace/coverage_view_selection/nerfstudio --no-deps -q || { echo 'FATAL: failed to install custom nerfstudio'; exit 1; }
        runuser -u $$USERNAME -- python -m pip install -e /workspace/coverage_view_selection --no-deps -q || { echo 'FATAL: failed to install coverage_view_selection'; exit 1; }
        # Verify all packages are importable
        runuser -u $$USERNAME -- python -c 'import figs, gemsplat, nbv_gym' || { echo 'FATAL: package import check failed'; exit 1; }
        runuser -u $$USERNAME -- figs-info
        exec runuser -u $$USERNAME -- bash -l
      "

